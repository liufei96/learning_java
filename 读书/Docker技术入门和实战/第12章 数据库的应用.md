目前，主流数据库包括关系型 (SQL) 和非关系型 (NoSQL) 两种。关系数据库是建立在关 系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据，支持复杂 的事物处理和结构化查询。代表实现有 MySQL Oracle PostGreSQL MariaDB SQLServer 等。 

非关系数据库是新兴的数据库技术，它放弃了传统关系型数据库的部分强一致性限制， 带来性能上的提升，使其更适用于需要大规模并行处理的场景。非关系型数据库是关系型数据库的良好补充，代表产品有 MongoDB、Redis 等。 

本章选取了最具代表性的数据库如 MySQL、Oracle、MongoDB、Redis、Cassandra 等， 来讲解基于 Docker 创建相关镜像并进行应用的过程。

# 12.1 MySQL

MySQL 是全球最流行的开源关系型数据库之一，由千其具有高性能、成熟可靠、高适应性、易用性而得到广泛应用。

## 1. 使用官方镜像

用户可以使用官方镜像快速启动一个 MySQL Server 实例：

```shell
[root@192 ~]# docker run --name hi-mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:latest
c26d757e1529166435285a295f4c1a6e4b4bdd205c783a01304042301b5786ab
```

以上指令中的 hi-mysql 是容器名称， 123456 为数据库的 root 用户密码。 

使用 docker ps 指令可以看到现在运行中的容器：

```shell
[root@192 ~]# docker ps
CONTAINER ID   IMAGE                     COMMAND                  CREATED          STATUS                 PORTS                                                                                                                 NAMES
c26d757e1529   mysql:latest              "docker-entrypoint.s…"   13 seconds ago   Up 13 seconds          3306/tcp, 33060/tcp 
```

当然，还可以使用 --link 标签将一个应用容器连接至 MySQL 容器：

```shell
[root@192 ~]# docker run --name some-app --link some-mysql:mysql -d application-that-uses-mysql
```

MySQL 服务的标准端口是 3306, 用户可以通过 CLI 工具对配置进行修改：

```shell
$ docker run -it --link some-mysql:mysql --rm mysql sh -c 'exec mysql -h"$MYSQL_ 
PORT_3366_TCP_ADDR" -P"$MYSQL_PORT_3306_TCP_PORT" -uroot -p"$MYSQL_ENV_MYSQL_ROOT_PASSWORD"' 
```

官方 MySQL 镜像还可以作为客户端，连接非 Docker 或者远程的 MySQL 实例：

```shell
[root@192 ~]# docker run -it --rm mysql mysql -h 192.168.245.129 -uroot -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 502
Server version: 5.7.36 MySQL Community Server (GPL)

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

### (1) 系统与日志访间

户可以使用 docker exec 指令调用内部系统中的 bash shell, 以访问容器内部系统：

```shell
[root@192 ~]# docker exec -it hi-mysql bash
root@c26d757e1529:/#
```

MySQL Server 日志可以使用 docker logs 指令查看：

```shell
[root@192 ~]# docker logs hi-mysql
```

### (2) 使用自定义配置文件

如果希望使用自定义 MySQL 配置，则可以创建一个目录，内置cnf 配置文件，然 后将其挂载至容器的/etc/mysql/conf.d 目录。比如，自定义配置文件为/root/dokcer/my_mysql/config-file.cnf，则可以使用以下指令：

```shell
[root@192 ~]# docker run --name some-mysql -v /root/dokcer/my_mysql:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=123456 -d mysql:latest

```

这时新的容器 some-mysql 启动后，就会结合使用/etc/mysql/my.cnf 和/etc/ mysql/conf.d/config-file.cnf 两个配置文件。

### (3) 脱离 cnf 文件进行配置

很多的配置选项可以通过标签 (flags) 传递至mysqld 进程，这样用户就可以脱离 cnf 配置文件，对容器进行弹性的定制。比如，用户需要改变默认编码方式，将所有表格的编码 方式修改为 uft8mb4, 则可以使用如下指令：

```shell
$ docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql
--character-set-server=utf8mb4 --Collation-server=utf8mb4_unicode_ci
```

如果需要查看可用选项的完整列表，可以执行如下指令：

```shell
$ docker run -it --rm mysql --verbose --help 
```

### (4) 通过 docker stack deploy 或 docker-compose 运行

MySQL 的示例 stack.yml 如下：

```yml
version: '3.1'

services:
  db:
    image: mysql
    restart: always
  	environment:
        MYSQL_ROOT_PASSWORD: example
  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
```

我们使用docker-compose来执行。没有安装的。先[安装](https://blog.csdn.net/ninimino/article/details/113388745)下

```shell
# 执行下面命令
[root@192 my_mysql]# docker-compose -f stack.yml up -d
Creating network "my_mysql_default" with the default driver
Pulling adminer (adminer:)...
latest: Pulling from library/adminer
...
Digest: sha256:c1258743fa99e7c1a48b0103e310ca37a80fe26e6499453c33716e4a162f5438
Status: Downloaded newer image for adminer:latest
Creating my_mysql_db_1      ... done
Creating my_mysql_adminer_1 ... done
```

成功之后，访问：[http://192.168.245.129:8080/](http://192.168.245.129:8080/)

![image-20220906234649551](.\image\12-docker-mysql-adminer.png)

## 2. 相关资源

MySQL 的相关资源如下：

-  MySQL 官网： https://www.mysql.com/
-  MySQL 官方镜像： https://hub.docker.com/_/mysql/ 
-  MySQL 官方镜像仓库： https://github.com/docker-library/mysql/

# 12.2 Oracle Database XE

Oracle Database 11g 快捷版 (Oracle Database XE) 是一款基于 oracle Database 11g 版代码库的小型入门级数据库，具备以下优点：

- 免费开发、部署和分发；

- 体积较小，下载速度快；
- 管理配置简单。

作为一款优秀的入门级数据库，它适合以下用户使用：

- 致力于 PHP、Java 、NET、XML 和开源应用程序的开发人员；
- 需要免费的入门级数据库进行培训和部署的 DBA;
- 需要入门级数据库进行免费分发的独立软件供应商(ISV) 和硬件供应商；
- 需要在课程中使用免费数据库的教育机构和学生。

Oracle Database XE 对安装主机的规模和 CPU 数量不作限制（每台计算机一个数据库），但XE将最多存储 11GB 的用户数据，同时最多使用 1GB 内存和主机上的一个CPU。

## 1. 搜索Oracle镜像

直接在 DockerHub 上搜索镜像，并下载 wnameless/oracle-xe-11g-r2 镜像：

```shell
[root@192 ~]# docker search -f stars=50 oracle
NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
oraclelinux                       Official Docker builds of Oracle Linux.         922       [OK]
oracleinanutshell/oracle-xe-11g                                                   232
gvenzl/oracle-xe                  Oracle Database XE (21c, 18c, 11g) for every…   102
wnameless/oracle-xe-11g-r2        Oracle Express Edition 11g Release 2 on Ubun…   87
```

## 2. 启动和使用容器

启动容器，并分别映射 22 和 1521 端口到本地的 49160 和 49161 端口：

```shell
[root@192 ~]# docker run --name oracle -d -p 1521:1521 -e ORACLE_ALLOW_REMOTE=true wnameless/oracle-xe-11g-r2
```

使用下列参数可以连接 oracle 数据库：

```shell
hostname: localhost
port: 49161
sid: xe
username: system
password: oracle
Password for SYS
```

启动并设置登录页面

```shell
[root@192 ~]# docker run -d -p 49161:1521 -p 8080:8080 wnameless/oracle-xe-11g-r2
```

本地请求：http://192.168.245.129:8080/apex/apex_admin

```shell
username: ADMIN
password: admin
```

输入用户名和密码

![image-20220908232022063](.\image\12-docker-oracle-login.png)



## 3. 相关资源

Oracle 的相关资源如下：

- OracleXE 官网： http://www.oracle.com/technetwork/database/database-technologies/expressedition/overview/index.html 

- OracleXE官方镜像：https://github.com/wnameless/docker-oracle-xe-11g
- Docker hub 官方镜像：https://hub.docker.com/r/wnameless/oracle-xe-11g-r2

# 12.3 



# 12.4 Redis

Redis 是一个开源 (BSD 许可）的基于内存的数据结构存储系统，可以用作数据库、缓存和消息中间件。 Redis 使用 ANSIC 实现， 2013 年起由 Pivotal 公司资助。 Redis 的全称意为： REmote Dictionary Server

Redis 支持多种类型的数据结构，如 string （字符串）、hash （散列）、 list （列 表）、 set （集合）、 sorted set （有序集合）与范围查询、 bitmaps、hyperloglogs、geospatial 引半径查询， Redis 同时支持 replication LUA 脚本、 LRU驱动事件、事务和不同级别的持久化支持等，通过哨兵机制和集群机制提供高可用性。

## 1. 使用官方镜像

可以通过 docker [container] run 指令直接启动一个 redis-container 容器：

```shell
[root@192 ~]# docker run --name redis-container -d redis
0efad48e7cc82fb358adc74fe0b0f07d26d709b38cacf5a764d3288c8b94a4c5
```

之后可以通过 docker ps 指令查看正在运行的 redis-container 容器的容器 ID:

```shell
[root@192 ~]# docker ps
CONTAINER ID   IMAGE                     COMMAND                  CREATED             STATUS                 PORTS                                                                                                                 NAMES
0efad48e7cc8   redis                     "docker-entrypoint.s…"   31 seconds ago      Up 29 seconds          6379/tcp  
```

下面，在此 redis 容器启动 bash, 并查看容器的运行时间和内存状况：

```shell
# 可能命令不存在，不过没关系，知道这命令就行
[root@192 ~]# docker exec -it 0efad48e7cc8 bash
root@0efad48e7cc8:/data# uptime
root@0efad48e7cc8:/data# free
```

同样，可以通过 env 指令查看环境变量的配置：

```shell

[root@192 ~]# docker exec -it 0efad48e7cc8 bash
root@0efad48e7cc8:/data# env
HOSTNAME=0efad48e7cc8
REDIS_DOWNLOAD_SHA=5b2b8b7a50111ef395bf1c1d5be11e6e167ac018125055daa8b5c2317ae131ab
PWD=/data
HOME=/root
REDIS_VERSION=6.2.6
GOSU_VERSION=1.12
TERM=xterm
REDIS_DOWNLOAD_URL=http://download.redis.io/releases/redis-6.2.6.tar.gz
SHLVL=1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
_=/usr/bin/env
```

也可以通过ps 指令查看当前容器运行的进程信息：

```shell
# 可能命令不存在，不过没关系，知道这命令就行
[root@192 ~]# docker exec -it 0efad48e7cc8 bash
root@0efad48e7cc8:/data# ps -ef
```

### (1) 连接 Redis 容器

户可以使用 --link 参数，连接创建的redis-container容器：

```shell
root@192 ~]# docker run -it --link redis-container:db alpine sh
/ # ls
bin    dev    etc    home   lib    media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var
/ # ping db
PING db (172.17.0.5): 56 data bytes
64 bytes from 172.17.0.5: seq=0 ttl=64 time=0.065 ms
64 bytes from 172.17.0.5: seq=1 ttl=64 time=0.075 ms
64 bytes from 172.17.0.5: seq=2 ttl=64 time=0.058 ms
64 bytes from 172.17.0.5: seq=3 ttl=64 time=0.060 ms
64 bytes from 172.17.0.5: seq=4 ttl=64 time=0.067 ms
64 bytes from 172.17.0.5: seq=5 ttl=64 time=0.054 ms
```

还可以使用 nc 指令（即 NetCat）检测 Redis 服务的可用性：

```shell
/ # nc db 6379
PING
+PONG
```

官方镜像内也自带了 Redis 客户端，可以使用以下指令直接使用：

```shell
[root@192 ~]# docker run -it --link redis-container:db --entrypoint redis-cli redis -h db
db:6379> ping
PONG
db:6379> set 1 2
OK
db:6379> get 1
"2"
```

### (2) 使用自定义配置

如果需要使用自定义的 Redis 配置，有以下两种操作：

- 通过 Dockerfile 构建自定义镜像；
- 使用数据卷。

下面首先介绍第一种方式。首先，新建项目目录并新建 Dockerfile 文件：

```dockerfile
FROM redis 
COPY redis.conf /usr/local/etc/redis/redis.conf
CMD [ "redis-server", "/usr/local/etc/redis/redis.conf" ] 
```

然后可以使用 docker build 指令，构建使用自定义配置的 Redis 镜像。

```shell
[root@192 redis]# docker build -t my_redis .
Sending build context to Docker daemon  109.6kB
Step 1/3 : FROM redis
 ---> 7614ae9453d1
Step 2/3 : COPY redis.conf /usr/local/etc/redis/redis.conf
 ---> 817a73816bea
Step 3/3 : CMD [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
 ---> Running in ebc15687fec3
Removing intermediate container ebc15687fec3
 ---> 6e3c600d0106
Successfully built 6e3c600d0106
Successfully tagged my_redis:latest
```

如果使用第二种方式，即通过数据卷实现自定义 Redis 配置，可以通过以下指令完成：

```shell
docker run -v /root/dokcer/redis/redis.conf:/usr/local/etc/redis/redis.conf --name myredis redis redis-server /usr/local/etc/redis/redis.conf 
```

## 2. 相关资源

Redis 的相关资源如下：

- Redis 官方网站： http://redis.io/
- Redis 官方镜像： https://hub.docker.corn/_/redis/ 
- Redis 官方镜像仓库： https://github.corn/docker-library/redis
